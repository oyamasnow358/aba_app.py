import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(
    page_title="ABA ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã‚¢ãƒ—ãƒª (Advanced)",
    page_icon="ğŸ“ˆ",
    layout="wide",
)

# --- æ”¹å–„ã•ã‚ŒãŸCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆåŠ¹æœãŒæ˜ç¢ºãªãƒ‡ãƒ¼ã‚¿ï¼‰ ---
# ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆ10/1-10/7ï¼‰: é »åº¦ãŒé«˜ã„
# ä»‹å…¥æœŸï¼ˆ10/8-10/14ï¼‰: é »åº¦ãŒæ¿€æ¸›ã™ã‚‹
template_csv = """ID,æ—¥æ™‚,å¯¾è±¡è¡Œå‹•,é »åº¦,æŒç¶šæ™‚é–“(åˆ†),å¼·åº¦,ãƒ•ã‚§ãƒ¼ã‚º,å‚™è€ƒ
1,2023-10-01 10:00,è‡ªå‚·è¡Œç‚º,5,10,4,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
2,2023-10-02 11:00,è‡ªå‚·è¡Œç‚º,6,12,5,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
3,2023-10-03 14:00,è‡ªå‚·è¡Œç‚º,8,15,5,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,æ‚ªå¤©å€™
4,2023-10-04 10:30,è‡ªå‚·è¡Œç‚º,5,8,4,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
5,2023-10-05 09:00,è‡ªå‚·è¡Œç‚º,7,10,5,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
6,2023-10-06 15:00,è‡ªå‚·è¡Œç‚º,9,20,5,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
7,2023-10-07 12:00,è‡ªå‚·è¡Œç‚º,8,15,5,ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³,
8,2023-10-08 10:00,è‡ªå‚·è¡Œç‚º,3,5,3,ä»‹å…¥æœŸ,ä»‹å…¥é–‹å§‹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
9,2023-10-09 11:00,è‡ªå‚·è¡Œç‚º,2,3,2,ä»‹å…¥æœŸ,
10,2023-10-10 14:00,è‡ªå‚·è¡Œç‚º,1,1,1,ä»‹å…¥æœŸ,
11,2023-10-11 10:00,è‡ªå‚·è¡Œç‚º,1,1,1,ä»‹å…¥æœŸ,
12,2023-10-12 09:00,è‡ªå‚·è¡Œç‚º,0,0,0,ä»‹å…¥æœŸ,ç™ºç”Ÿãªã—
13,2023-10-13 15:00,è‡ªå‚·è¡Œç‚º,1,2,1,ä»‹å…¥æœŸ,
14,2023-10-14 12:00,è‡ªå‚·è¡Œç‚º,0,0,0,ä»‹å…¥æœŸ,
"""

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
st.title("ğŸ“ˆ å¿œç”¨è¡Œå‹•åˆ†æ (ABA) ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã‚¢ãƒ—ãƒª")
st.markdown("""
è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã€ä»‹å…¥ã®åŠ¹æœã‚’åˆ†æã—ã¾ã™ã€‚
**ABAï¼ˆå˜ä¸€äº‹ä¾‹è¨­è¨ˆï¼‰**ã®åŸå‰‡ã«åŸºã¥ãã€ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®å‚¾å‘ç·šã‚„æ—¥æ¬¡é›†è¨ˆæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
""")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
with st.sidebar:
    st.header("1. ãƒ‡ãƒ¼ã‚¿æº–å‚™")
    st.download_button(
        label="ğŸ“„ æ˜ç¢ºãªå¤‰åŒ–ãŒã‚ã‚‹ã‚µãƒ³ãƒ—ãƒ«CSVã‚’DL",
        data=template_csv.encode('utf-8-sig'),
        file_name="aba_sample_clear.csv",
        mime="text/csv"
    )
    
    st.header("2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    uploaded_file = st.file_uploader(
        "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
        type=["csv"],
        label_visibility="collapsed"
    )

if uploaded_file is None:
    st.info("ğŸ‘ˆ ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ã‚’DLã—ã¦ãã®ã¾ã¾ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨å‰å‡¦ç† ---
try:
    df = pd.read_csv(uploaded_file, encoding='utf-8-sig')
    df.columns = df.columns.str.strip()

    if 'æ—¥æ™‚' in df.columns:
        df['æ—¥æ™‚'] = pd.to_datetime(df['æ—¥æ™‚'], errors='coerce')
        df.dropna(subset=['æ—¥æ™‚'], inplace=True)
        # æ—¥ä»˜ã®ã¿ã®åˆ—ã‚’ä½œæˆï¼ˆé›†è¨ˆç”¨ï¼‰
        df['æ—¥ä»˜'] = df['æ—¥æ™‚'].dt.date
    else:
        st.error("âŒ 'æ—¥æ™‚'åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        st.stop()

except Exception as e:
    st.error(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
    st.stop()

# --- åˆ†ææ¡ä»¶è¨­å®š ---
with st.sidebar:
    st.header("3. åˆ†ææ¡ä»¶ã®è¨­å®š")
    
    # å¯¾è±¡è¡Œå‹•ã®é¸æŠ
    if 'å¯¾è±¡è¡Œå‹•' in df.columns:
        all_behaviors = df['å¯¾è±¡è¡Œå‹•'].unique()
        selected_behavior = st.selectbox("åˆ†æã™ã‚‹å¯¾è±¡è¡Œå‹•ã‚’é¸æŠï¼ˆå˜ä¸€é¸æŠæ¨å¥¨ï¼‰", all_behaviors)
    else:
        selected_behavior = None
    
    # æ—¥æ¬¡é›†è¨ˆã‚¹ã‚¤ãƒƒãƒï¼ˆABAé‡è¦æ©Ÿèƒ½ï¼‰
    st.markdown("---")
    st.write("ğŸ“Š **è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³**")
    use_daily_agg = st.checkbox("æ—¥æ¬¡ã§é›†è¨ˆã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰", value=True, help="ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨1æ—¥ã”ã¨ã®åˆè¨ˆãƒ»å¹³å‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚å…¨ä½“ã®å‚¾å‘ãŒã¤ã‹ã¿ã‚„ã™ããªã‚Šã¾ã™ã€‚")
    split_phase_line = st.checkbox("ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ç·šã‚’åˆ†ã‘ã‚‹", value=True, help="ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ä»‹å…¥æœŸã®ç·šã‚’è¦–è¦šçš„ã«åˆ‡æ–­ã—ã¾ã™ã€‚")

# ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
df_target = df[df['å¯¾è±¡è¡Œå‹•'] == selected_behavior].copy()

if df_target.empty:
    st.warning("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
    st.stop()

# --- ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆå‡¦ç†ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ç‚¹ï¼‰ ---
if use_daily_agg:
    # æ—¥ä»˜ã¨ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    # é »åº¦ãƒ»æŒç¶šæ™‚é–“ã¯ã€Œåˆè¨ˆ(sum)ã€ã€å¼·åº¦ã¯ã€Œå¹³å‡(mean)ã€ãŒä¸€èˆ¬çš„
    agg_rules = {}
    if 'é »åº¦' in df_target.columns: agg_rules['é »åº¦'] = 'sum'
    if 'æŒç¶šæ™‚é–“(åˆ†)' in df_target.columns: agg_rules['æŒç¶šæ™‚é–“(åˆ†)'] = 'sum'
    if 'å¼·åº¦' in df_target.columns: agg_rules['å¼·åº¦'] = 'mean'
    
    # ãƒ•ã‚§ãƒ¼ã‚ºãŒå¤‰ã‚ã‚‹æ—¥ãŒã‚ã‚‹å ´åˆã‚’è€ƒæ…®ã—ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚‚å«ã‚ã¦ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    df_plot = df_target.groupby(['æ—¥ä»˜', 'ãƒ•ã‚§ãƒ¼ã‚º']).agg(agg_rules).reset_index()
    x_col = 'æ—¥ä»˜'
    hover_data = ['ãƒ•ã‚§ãƒ¼ã‚º']
    st.success(f"âœ… **æ—¥æ¬¡é›†è¨ˆãƒ¢ãƒ¼ãƒ‰** ã§è¡¨ç¤ºä¸­: {len(df_plot)}æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿")
else:
    df_plot = df_target.sort_values('æ—¥æ™‚')
    x_col = 'æ—¥æ™‚'
    hover_data = ['ãƒ•ã‚§ãƒ¼ã‚º', 'å‚™è€ƒ'] if 'å‚™è€ƒ' in df_target.columns else ['ãƒ•ã‚§ãƒ¼ã‚º']
    st.info("â„¹ï¸ **è©³ç´°ãƒ¢ãƒ¼ãƒ‰** ã§è¡¨ç¤ºä¸­: å…¨ã¦ã®è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º")

# --- ã‚°ãƒ©ãƒ•æç”» ---
st.markdown("---")
st.subheader(f"ã€Œ{selected_behavior}ã€ã®æ¨ç§»ã‚°ãƒ©ãƒ•")

y_axis_option = st.selectbox(
    "ç¸¦è»¸ã‚’é¸æŠ",
    [col for col in ['é »åº¦', 'æŒç¶šæ™‚é–“(åˆ†)', 'å¼·åº¦'] if col in df_plot.columns]
)

if y_axis_option:
    # ABAã‚°ãƒ©ãƒ•ã®ä½œæˆ
    # ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ç·šã‚’åˆ†ã‘ã‚‹ãŸã‚ã« `color` ã¾ãŸã¯ `group` ã‚’ä½¿ç”¨ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
    if split_phase_line:
        # ãƒ•ã‚§ãƒ¼ã‚ºã‚’è‰²åˆ†ã‘ï¼ˆã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰ã«ä½¿ç”¨ã—ã¦ç·šã‚’åˆ†æ–­ã™ã‚‹
        fig_time = px.line(
            df_plot, 
            x=x_col, 
            y=y_axis_option, 
            color='ãƒ•ã‚§ãƒ¼ã‚º',  # ã“ã‚Œã«ã‚ˆã‚Šãƒ•ã‚§ãƒ¼ã‚ºé–“ã§ç·šãŒåˆ‡ã‚Œã‚‹
            markers=True,
            symbol='ãƒ•ã‚§ãƒ¼ã‚º', # å½¢ã‚‚å¤‰ãˆã¦è¦‹ã‚„ã™ãã™ã‚‹
            title=f'{selected_behavior}ï¼š{y_axis_option}ã®æ¨ç§»ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºæ¯”è¼ƒï¼‰',
        )
    else:
        # å…¨ä½“ã‚’ã¤ãªã’ã¦è¡¨ç¤º
        fig_time = px.line(
            df_plot, 
            x=x_col, 
            y=y_axis_option, 
            markers=True,
            title=f'{selected_behavior}ï¼š{y_axis_option}ã®æ¨ç§»',
        )
        # ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ç·šã®è¿½åŠ ï¼ˆã¤ãªãŒã£ã¦ã„ã‚‹å ´åˆã®ã¿å‚ç›´ç·šãŒå½¹ç«‹ã¤ï¼‰
        if 'ãƒ•ã‚§ãƒ¼ã‚º' in df_plot.columns:
            # æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒ•ã‚§ãƒ¼ã‚ºã®å¤‰ã‚ã‚Šç›®ã‚’æ¢ã™
            df_sorted = df_plot.sort_values(x_col)
            # ãƒ•ã‚§ãƒ¼ã‚ºãŒå¤‰ã‚ã‚‹è¡Œã‚’ç‰¹å®š
            phase_changes = df_sorted[df_sorted['ãƒ•ã‚§ãƒ¼ã‚º'] != df_sorted['ãƒ•ã‚§ãƒ¼ã‚º'].shift(1)]
            # æœ€åˆã®è¡Œä»¥å¤–ï¼ˆå¤‰ã‚ã‚Šç›®ï¼‰ã«ç·šã‚’å¼•ã
            for i, row in phase_changes.iterrows():
                if i != df_sorted.index[0]: # ãƒ‡ãƒ¼ã‚¿ã®å…ˆé ­ã¯é™¤å¤–
                    fig_time.add_vline(
                        x=row[x_col], line_width=2, line_dash="dash", line_color="red",
                        annotation_text="ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´", annotation_position="top left"
                    )

    fig_time.update_layout(xaxis_title="æ—¥æ™‚", yaxis_title=y_axis_option)
    st.plotly_chart(fig_time, use_container_width=True)

    # --- è§£èª¬ã¨è§£é‡ˆ ---
    st.markdown("#### ğŸ’¡ è¦–è¦šçš„åˆ†æã®ãƒã‚¤ãƒ³ãƒˆ")
    col_a, col_b = st.columns(2)
    
    # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ä»‹å…¥æœŸã®å¹³å‡å€¤ã‚’è¨ˆç®—ã—ã¦æ¯”è¼ƒ
    if 'ãƒ•ã‚§ãƒ¼ã‚º' in df_plot.columns:
        means = df_plot.groupby('ãƒ•ã‚§ãƒ¼ã‚º')[y_axis_option].mean()
        # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ä»‹å…¥æœŸã®å€¤ãŒã‚ã‚Œã°æ¯”è¼ƒè¡¨ç¤º
        if 'ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³' in means and 'ä»‹å…¥æœŸ' in means:
            diff = means['ä»‹å…¥æœŸ'] - means['ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³']
            ratio = (means['ä»‹å…¥æœŸ'] / means['ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³']) * 100 if means['ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³'] != 0 else 0
            
            with col_a:
                st.metric(
                    label="ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æœŸ å¹³å‡",
                    value=f"{means['ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³']:.2f}"
                )
            with col_b:
                st.metric(
                    label="ä»‹å…¥æœŸ å¹³å‡",
                    value=f"{means['ä»‹å…¥æœŸ']:.2f}",
                    delta=f"{diff:.2f} ({ratio:.0f}%)",
                    delta_color="inverse" # æ¸›å°‘ãŒè‰¯ã„ã“ã¨ã¨ã—ã¦ç·‘è‰²è¡¨ç¤ºï¼ˆé€†ãªã‚‰normalï¼‰
                )
            
            st.info(
                f"**åˆ†æçµæœ:** ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æœŸã¨æ¯”è¼ƒã—ã¦ã€ä»‹å…¥æœŸã§ã¯æ•°å€¤ãŒ **{abs(diff):.2f} ãƒã‚¤ãƒ³ãƒˆ{'æ¸›å°‘' if diff < 0 else 'å¢—åŠ '}** ã—ã¦ã„ã¾ã™ã€‚\n"
                f"ã“ã‚ŒãŒæ„å›³ã—ãŸå¤‰åŒ–ã§ã‚ã‚Œã°ã€ä»‹å…¥ã«åŠ¹æœãŒã‚ã£ãŸå¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã¾ã™ã€‚"
            )

# --- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆç°¡æ˜“ç‰ˆï¼‰ ---
with st.expander("ğŸ“ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹"):
    st.dataframe(df_plot)